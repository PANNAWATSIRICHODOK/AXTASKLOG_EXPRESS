<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autoxing Robot Control</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .container {
        background: #f9f9f9;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: auto;
        padding: 30px;
        text-align: center;
      }
      h1 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: #1a73e8;
        font-family: "Roboto", sans-serif;
        text-align: left;
      }
      .form-group {
        text-align: left;
        margin-bottom: 20px;
      }
      .form-group input {
        width: 500px;
      }
      label {
        width: 20px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
        font-family: "Roboto", sans-serif;
      }
      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background: #fff;
        color: #333;
        font-size: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-family: "Roboto", sans-serif;
      }
      button {
        padding: 12px;
        margin-top: 10px;
        font-size: 1rem;
        font-weight: bold;
        background: #1a73e8;
        border: none;
        border-radius: 5px;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "Roboto", sans-serif;
      }
      button:hover {
        background: #0056b3;
        box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
      }
      .result,
      .debug {
        text-align: left;
        font-size: 1rem;
        padding: 15px;
        color: #333;
        overflow-x: auto;
        font-family: "Roboto", sans-serif;
      }
      .result-table {
        margin-top: 20px;
        border-collapse: collapse;
        width: 100%;
        overflow-x: auto;
      }
      .result-table th,
      .result-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
        font-size: 1rem;
      }
      .result-table th {
        background-color: #1a73e8;
        color: #fff;
      }
      .debug {
        background: #f5f5f5;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 20px;
        overflow-y: auto;
        max-height: 200px;
      }
      @media (max-width: 768px) {
        h1 {
          font-size: 1.8rem;
        }
        button {
          font-size: 0.9rem;
          padding: 10px;
        }
        input {
          font-size: 0.9rem;
        }
      }
      @media (max-width: 480px) {
        h1 {
          font-size: 1.5rem;
        }
        button {
          font-size: 0.8rem;
        }
        input {
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1><i class="fas fa-robot"></i> Autoxing Robot Control Panel</h1>
      <div class="form-group">
        <label for="robotId">Robot ID:</label>
        <input type="text" id="robotId" placeholder="Enter Robot ID" />
        <button id="connect">
          <i class="fas fa-link"></i> Connect to Robot
        </button>
      </div>
      <div id="result" class="result"></div>
      <div id="statisticsResult" class="result"></div>
      <div id="debug" class="debug">
        <strong>Debug Logs:</strong>
        <pre id="debugLogs"></pre>
      </div>
    </div>

    <script>
      const backendUrl = "http://localhost:3000";

      document.getElementById("connect").addEventListener("click", async () => {
        const robotId = document.getElementById("robotId").value;
        const resultDiv = document.getElementById("result");
        const statisticsResultDiv = document.getElementById("statisticsResult");
        const debugLogs = document.getElementById("debugLogs");

        const logDebug = (message) => {
          debugLogs.textContent += `${message}\n`;
        };

        try {
          logDebug("Connecting to robot...");
          const response = await axios.post(`${backendUrl}/connect`, {
            robotId,
          });

          const { message, currentTask, statistics } = response.data;

          logDebug("Connection successful. Processing data...");

          resultDiv.innerHTML = `<p>${message}</p>`;

          if (currentTask) {
            logDebug("Current task retrieved successfully.");

            // Define key fields to display
            const keyFields = {
              taskId: "Task ID",
              name: "Task Name",
              runType: "Run Type",
              taskType: "Task Type",
              robotId: "Robot ID",
              createTime: "Creation Time",
              isExcute: "Is Executed",
            };

            // Filter and display key fields
            const filteredTaskDetails = Object.entries(currentTask)
              .filter(([key]) => key in keyFields)
              .map(
                ([key, value]) =>
                  `<tr><td>${keyFields[key]}</td><td>${
                    value || "N/A"
                  }</td></tr>`
              )
              .join("");

            resultDiv.innerHTML += `
      <h3>Current Task</h3>
      <table class="result-table">
        <thead>
          <tr>
            <th>Property</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          ${filteredTaskDetails}
        </tbody>
      </table>`;
          } else {
            logDebug("No current task available.");
            resultDiv.innerHTML += "<p>No current task available.</p>";
          }

          if (statistics && statistics.lists) {
            logDebug("Statistics retrieved successfully.");
            statisticsResultDiv.innerHTML = `<h3>Statistics</h3>${generateStatisticsListsTable(
              statistics.lists
            )}`;
          } else {
            statisticsResultDiv.innerHTML = "<p>No Statistics Data Found</p>";
          }
        } catch (error) {
          logDebug("Error occurred during the connection process.");
          resultDiv.innerHTML = `<p>Error: ${
            error.message || error.response?.data?.error
          }</p>`;
        }
      });

      function generateStatisticsListsTable(lists) {
        if (!lists || !lists.length) return "<p>No statistics available.</p>";

        return `
  <table class="result-table">
    <thead>
      <tr>${Object.keys(lists[0])
        .map((key) => `<th>${key}</th>`)
        .join("")}</tr>
    </thead>
    <tbody>
      ${lists
        .map(
          (item) =>
            `<tr>${Object.values(item)
              .map((val) => `<td>${val || "N/A"}</td>`)
              .join("")}</tr>`
        )
        .join("")}
    </tbody>
  </table>`;
      }
    </script>
  </body>
</html>
